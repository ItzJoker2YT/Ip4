name: Create VPS

permissions:
  contents: write     # ✅ Allow GitHub Actions to push commits

on:
  workflow_dispatch:   # Manual trigger
  repository_dispatch: # Optional API trigger
    types: [create-vps]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Keep VPS alive for up to 6 hours

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v3

      - name: 📁 Create directories
        run: mkdir -p links .backup

      - name: 💾 Restore previous backup (optional)
        run: |
          name="${{ github.event.client_payload.vps_name }}"
          if [ "${{ github.event.client_payload.backup }}" == "true" ]; then
            echo "📦 Restoring backup..."
            unzip ".backup/$name.zip" -d . || echo "⚠️ No backup to restore."
          fi

      - name: 🔐 Set root password & enable SSH
        run: |
          echo "root:root" | sudo chpasswd
          sudo mkdir -p /var/run/sshd
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart

      - name: 🌐 Install Ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          curl -s https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin/
          ngrok authtoken $NGROK_TOKEN

      - name: 🚀 Start Ngrok tunnel
        run: |
          nohup ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
          echo "⏳ Waiting for Ngrok tunnel..."
          sleep 5
          cat ngrok.log | grep -Eo "tcp://[0-9a-zA-Z\.-]+:[0-9]+" | tail -n 1 > tunnel.txt
          if [ ! -s tunnel.txt ]; then
            echo "❌ Ngrok tunnel not found!"
            exit 1
          fi
          TUNNEL=$(cat tunnel.txt)
          echo "✅ SSH Ready via Ngrok:"
          echo "ssh root@${TUNNEL#tcp://} (password: root)"
          echo "ssh root@${TUNNEL#tcp://} (password: root)" > "links/vps-ssh.txt"

      - name: 💾 Save backup
        run: |
          name="${{ github.event.client_payload.vps_name || 'manual-vps' }}"
          zip -r ".backup/$name.zip" . -x ".git/*" ".github/*" ".backup/*" || true

      - name: 📤 Commit and push SSH info
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔁 Updated SSH Ngrok tunnel info"
          file_pattern: 'links/*.txt .backup/*.zip'
          commit_author: ItzJoker2YT <218676716+ItzJoker2YT@users.noreply.github.com>

      - name: ⏳ Keep VPS session alive
        run: |
          echo "⏳ VPS active for 6 hours..."
          sleep $((360 * 60))
