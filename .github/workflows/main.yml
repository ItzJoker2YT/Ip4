name: Ngrok SSH Tunnel

on:
  workflow_dispatch:

jobs:
  ngrok-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours

    env:
      NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y openssh-server wget unzip curl jq

      - name: Configure SSH
        run: |
          echo "root:root" | sudo chpasswd
          sudo mkdir -p /var/run/sshd
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart || sudo /etc/init.d/ssh start

      - name: Install Ngrok
        run: |
          wget -q -O ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok.tgz
          chmod +x ngrok

      - name: Authenticate Ngrok
        run: ./ngrok config add-authtoken $NGROK_TOKEN

      - name: Start SSH tunnel and show info
        run: |
          nohup ./ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
          echo "‚è≥ Waiting for Ngrok tunnel..."
          for i in {1..30}; do
            sleep 2
            TUNNEL_URL=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' 2>/dev/null)
            if [[ "$TUNNEL_URL" == tcp* ]]; then
              break
            fi
            echo "Waiting $i/30..."
          done
          if [[ "$TUNNEL_URL" == tcp* ]]; then
            HOST=$(echo "$TUNNEL_URL" | sed 's/tcp:\/\///' | cut -d':' -f1)
            PORT=$(echo "$TUNNEL_URL" | sed 's/tcp:\/\///' | cut -d':' -f2)
            echo "‚úÖ SSH Tunnel Active!"
            echo "--------------------------------------"
            echo "üîó Command: ssh root@$HOST -p $PORT"
            echo "üîë Password: root"
            echo "--------------------------------------"
            echo "üïí Tunnel will run for 6 hours"
          else
            echo "‚ùå Ngrok failed to start. Last 15 log lines:"
            tail -n 15 ngrok.log
          fi

      - name: Keep tunnel alive
        run: sleep 21600  # 6 hours in seconds
