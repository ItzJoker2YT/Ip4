name: Create VPS (Ngrok Tunnel)

on:
  workflow_dispatch:

jobs:
  create-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Run up to 6 hours

    env:
      NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v3

      - name: ⚙️ Install requirements
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y openssh-server curl wget unzip jq
          sudo systemctl enable ssh
          sudo mkdir -p /var/run/sshd

      - name: 🔐 Set root password
        run: |
          echo "root:root" | sudo chpasswd
          sudo sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh start

      - name: 🌀 Download and setup Ngrok
        run: |
          wget -q -O ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok.tgz
          ./ngrok config add-authtoken $NGROK_TOKEN

      - name: 🚀 Start Ngrok tunnel
        run: |
          nohup ./ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
          echo "⏳ Waiting for Ngrok tunnel to initialize..."

          # Wait up to 30 seconds for ngrok to boot
          for i in {1..30}; do
            if curl -s http://127.0.0.1:4040/api/tunnels >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          # Fetch tunnel info
          TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -Eo 'tcp://[0-9a-zA-Z\.-]+:[0-9]+')

          if [ -z "$TUNNEL_URL" ]; then
            echo "❌ Ngrok tunnel not found!"
            echo "---- ngrok.log ----"
            cat ngrok.log
            exit 1
          fi

          echo "✅ SSH Ready via Ngrok:"
          echo "ssh root@${TUNNEL_URL#tcp://} (password: root)"
          echo "ssh root@${TUNNEL_URL#tcp://} (password: root)" > links/vps-ssh.txt

      - name: 💾 Commit SSH info
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔁 Updated SSH Ngrok tunnel info"
          file_pattern: links/vps-ssh.txt
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          push_options: '--force'

      - name: ⏳ Keep VPS alive (6h)
        run: |
          echo "⏳ VPS active for 6 hours..."
          sleep $((360 * 60))
